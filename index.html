<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH·ªäNH ƒêZ EDU - Admin Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- STYLE --- */
        :root { --pri: #4e54c8; --sec: #8f94fb; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--pri); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #loginWrap { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); display:flex; justify-content:center; align-items:center; z-index:999; }
        .login-box { background:white; padding:40px; border-radius:15px; width:380px; text-align:center; box-shadow:0 15px 40px rgba(0,0,0,0.2); }
        
        #appWrap { display:none; height:100%; }
        .sidebar { width:260px; background:#fff; display:flex; flex-direction:column; border-right:1px solid #ddd; }
        .content { flex:1; padding:30px; overflow-y:auto; background: var(--bg); }
        
        .user-panel { padding:20px; background:linear-gradient(135deg, var(--pri), var(--sec)); color:white; display:flex; align-items:center; gap:15px; }
        .menu-cat { font-size:11px; font-weight:bold; color:#888; text-transform:uppercase; margin:15px 0 5px 10px; }
        .menu-item { padding:12px 15px; border-radius:8px; cursor:pointer; display:flex; gap:12px; align-items:center; color:#555; font-weight:600; transition:0.2s; }
        .menu-item:hover, .menu-item.active { background:#eef2ff; color:var(--pri); }
        
        .card { background:white; border-radius:12px; padding:25px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.03); animation: slideIn 0.4s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        
        input, select, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; outline:none; box-sizing:border-box; }
        .btn { background:var(--pri); color:white; padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.2s; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-warning { background: #f39c12; }
        
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th { text-align:left; color:#777; font-size:12px; text-transform:uppercase; padding:10px; border-bottom:2px solid #eee; }
        td { padding:12px 10px; border-bottom:1px solid #eee; vertical-align:middle; }
        
        .legal-paper { background: #fff; padding: 40px 50px; border: 1px solid #ccc; font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 0 auto; max-width: 800px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); }
        .legal-header { text-align: center; margin-bottom: 20px; }
        .legal-nation { font-weight: bold; text-transform: uppercase; }
        .legal-motto { font-weight: bold; border-bottom: 1px solid #000; display: inline-block; padding-bottom: 5px; }
        .legal-title { text-align: center; font-weight: bold; text-transform: uppercase; font-size: 16pt; margin: 30px 0; }
        .legal-input { border: none; border-bottom: 1px dotted #000; outline: none; width: auto; background: transparent; font-family: inherit; font-size: inherit; }
        .date-input { font-family: inherit; font-size: inherit; border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; background: #fffbe6; cursor: pointer; }

        .badge { padding:4px 10px; border-radius:20px; font-size:11px; font-weight:bold; color:white; }
        .bg-ok { background:#00b894; } .bg-wait { background:#fdcb6e; color:#333; } .bg-no { background:#ff7675; }

        /* REPLY MODAL & SLASH MENU */
        #replyModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .reply-box { background: white; width: 500px; border-radius: 15px; padding: 25px; position: relative; }
        #slashMenu { position: absolute; bottom: 85px; left: 25px; width: 250px; background: white; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; z-index: 10001; }
        .slash-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f9f9f9; }
        .slash-item:hover { background: #f0f2ff; color: var(--pri); }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div><p style="margin-top:10px; font-weight:bold; color:var(--pri)">ƒêang n·∫°p d·ªØ li·ªáu H·ªá th·ªëng...</p></div>

    <div id="loginWrap">
        <div class="login-box">
            <h2 style="color:var(--pri); margin-bottom:5px">TH·ªäNH ƒêZ EDU</h2>
            <p style="color:#888; font-size:13px; margin-bottom:25px">Qu·∫£n tr·ªã L·ªõp 8B - NƒÉm h·ªçc 2025</p>
            <input id="user" placeholder="T√™n ƒëƒÉng nh·∫≠p (admin / gv / m.an...)">
            <input id="pass" type="password" placeholder="M·∫≠t kh·∫©u (123)">
            <button class="btn" style="width:100%" onclick="login()">ƒêƒÉng Nh·∫≠p</button>
        </div>
    </div>

    <div id="appWrap">
        <div class="sidebar">
            <div class="user-panel">
                <div style="width:45px; height:45px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center"><i class="fa fa-user"></i></div>
                <div><div style="font-weight:bold" id="uName">User</div><small id="uRole">Role</small></div>
            </div>
            <div class="menu-scroll" id="menuArea" style="flex:1; overflow-y:auto; padding:10px;"></div>
            <div style="padding:15px; border-top:1px solid #eee">
                <button class="btn" onclick="syncData()" style="width:100%; margin-bottom:10px; background:#00b894"><i class="fa fa-sync"></i> ƒê·ªìng b·ªô d·ªØ li·ªáu</button>
                <button onclick="location.reload()" class="btn" style="width:100%; background:#fff; color:#ff7675; border:1px solid #ff7675"><i class="fa fa-power-off"></i> ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        <div class="content" id="mainContent"></div>
    </div>

    <div id="replyModal">
        <div class="reply-box">
            <h3 style="margin-top:0; color:var(--pri)">üí¨ Ph·∫£n H·ªìi ƒê∆°n</h3>
            <div style="margin-bottom: 15px; font-weight: bold;">Tr·∫°ng th√°i: <span id="statusPreview" style="background:#eee; padding:3px 8px; border-radius:5px">Ch∆∞a ch·ªçn</span></div>
            <textarea id="replyTxt" style="width:100%; height:100px; padding:15px; border:2px solid #e0e0e0; border-radius:10px; resize:none" placeholder="G√µ d·∫•u / ƒë·ªÉ ch·ªçn l·ªánh nhanh (ƒê·ªìng √Ω/Kh√¥ng)..."></textarea>
            <div id="slashMenu">
                <div class="slash-item" onclick="selectSlash('ƒê√£ duy·ªát', 'ƒê·ªìng √Ω')"><i class="fa fa-check-circle" style="color:#00b894"></i> <b>/dongy</b></div>
                <div class="slash-item" onclick="selectSlash('H·ªßy', 'Kh√¥ng ƒë·ªìng √Ω')"><i class="fa fa-times-circle" style="color:#ff7675"></i> <b>/khong</b></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px">
                <button class="btn" style="background:#ddd; color:#333" onclick="document.getElementById('replyModal').style.display='none'">ƒê√≥ng</button>
                <button class="btn" onclick="submitReplyFinal()">G·ª≠i Ph·∫£n H·ªìi</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH API ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxblDPpUu6rd2duywYrlMv-mRKfrktQSzW3h_XQTNUjAXpEKe-rh_W4kF3Vez1RC802/exec"; 
        const WH_PUBLIC = "https://discord.com/api/webhooks/1456305070181449789/gySnBocRkplcH8UrQvWpnDkg_8472oeOUFCjgOh23NkaGKbMFd7_crtncR5CF44D9lk7?wait=true";
        const WH_PRIVATE = "https://discord.com/api/webhooks/1456659542699151598/j0LjBOW3wUnNN0p7lWeL5kvbfC4iITGuw5tZ47AWzVluPnsom1qrGGrKMRg3F1cIRRrY?wait=true";

        // --- 2. KH·ªûI T·∫†O USER (CH·∫†Y 1 L·∫¶N ƒê·∫¶U) ---
        const rawStudents = ['B√πi V≈© Minh An','Tr∆∞∆°ng Th·ªã Di·ªáu Anh','L∆∞∆°ng Gia B·∫£o','√ä Ban Any T√πng','Nguy·ªÖn Cao Tr∆∞·ªùng H·∫£i','ƒê·ªó Ng·ªçc H√¢n','ƒêinh Th·ªã B√≠ch Hi·ªÅn','L√™ VƒÉn Hi·∫øu','Hu·ª≥nh Nguy·ªÖn Minh Ho√†ng','L√™ Ng·ªçc Ho√†ng','D∆∞∆°ng Qu·ªëc Kh·∫£i','Nguy·ªÖn Ng·ªçc Thi√™n Kim','Hu·ª≥nh Cao Nh·∫≠t L√¢m','Nguy·ªÖn Quang Long','TRI·ªÜU M·∫™N','TƒÉng H·ªØu Nam','Nguy·ªÖn Th√πy B·∫£o Ng√¢n','Nguy·ªÖn Tr·∫ßn Ng·ªçc Ng√¢n','Nguy·ªÖn Ho√†ng B·∫£o Ng·ªçc','Ph·∫°m Minh Ph∆∞·ªõc','L√™ Ho√†ng Qu√¢n','Nguy·ªÖn ƒêƒÉng Qu√¢n','Tr·∫ßn Qu·ªëc Qu√¢n','Nguy·ªÖn Th·ª•c Quy√™n','T·ªëng Thanh Thanh','L√™ VƒÉn Th·∫£o','Tr·∫ßn B·∫£o Th·∫Øng','Tr·∫ßn Th·∫Øng','L√™ Tr·∫ßn Ph√∫c Thi√™n','L√™ Th·∫ø Th·ªãnh','Ng√¥ Nguy·ªÖn B·∫£o Th·ªãnh','L∆∞∆°ng Nguy·ªÖn Anh Th∆∞','Nguy·ªÖn Anh Th∆∞','Tr·ªãnh Nguy·ªÖn Minh Th∆∞','Tr·∫ßn Ho√†i Th∆∞∆°ng','Nguy·ªÖn Ng·ªçc Kh√°nh Thy','ƒê·ªó Ph·∫°m Huy·ªÅn Tr√¢n','Tr·∫ßn Th·ªã B·∫£o Tr√¢n','Ho√†ng Th·ªßy Tr√∫c','Nguy·ªÖn Hu·ª≥nh Nh∆∞ Tr√∫c','Ph·∫°m Thanh Trung','V√µ Ho√†ng Th·ª•y V√¢n'];
        
        function cleanName(str) { str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); str = str.replace(/ƒë/g,"d"); return str; }
        function genId(name) { let clean = cleanName(name).toLowerCase().trim().split(/\s+/); if(clean.length<2) return clean[0]; return clean[clean.length-2].charAt(0) + '.' + clean[clean.length-1]; }

        // D·ªØ li·ªáu g·ªëc ƒë·ªÉ kh·ªüi t·∫°o
        const defaultUsers = [{u:'admin',p:'123',n:'Admin H·ªá Th·ªëng',r:'admin',c:'ALL'}, {u:'gv',p:'123',n:'GVCN 8B',r:'teacher',c:'8B'}];
        const studentList = []; const used = {};
        rawStudents.forEach(n => {
            let base = genId(n); let id = used[base] ? base + used[base] : base;
            if(used[base]) used[base]++; else used[base]=1;
            defaultUsers.push({u:id, p:'123', n:n, r:'student', c:'8B'});
            studentList.push({id:id, name:n});
        });

        // --- 3. DATABASE ONLINE ---
        let DB = { reqs: [], weekly: [], users: [] };
        let curr = null;

        window.onload = async function() {
            await loadOnlineData();
        }

        async function loadOnlineData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                // N·∫øu DB online r·ªóng (l·∫ßn ƒë·∫ßu ch·∫°y), n·∫°p danh s√°ch user m·∫∑c ƒë·ªãnh
                if(!data || data.init || !data.users || data.users.length === 0) {
                    DB.users = defaultUsers;
                    DB.reqs = [];
                    DB.weekly = [];
                    await saveOnlineData(); // ƒê·∫©y user l√™n Google Sheet
                } else {
                    DB = data; // D√πng d·ªØ li·ªáu t·ª´ Sheet
                }
            } catch(e) { console.error("L·ªói t·∫£i d·ªØ li·ªáu", e); }
            document.getElementById('loading').style.display = 'none';
        }

        async function saveOnlineData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(DB)
                });
            } catch(e) { console.error("L·ªói l∆∞u d·ªØ li·ªáu", e); }
            document.getElementById('loading').style.display = 'none';
        }

        async function syncData() {
            await loadOnlineData();
            const activeItem = document.querySelector('.menu-item.active');
            if(activeItem) activeItem.click();
            alert("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi nh·∫•t!");
        }

        // --- 4. CORE LOGIN & NAV ---
        async function login() {
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;
            // Ki·ªÉm tra user tr√™n d·ªØ li·ªáu ƒë√£ t·∫£i t·ª´ Google Sheets
            const f = DB.users.find(x => x.u == u && x.p == p);
            
            if(f) { 
                curr = f;
                document.getElementById('loginWrap').style.display='none'; 
                document.getElementById('appWrap').style.display='flex'; 
                document.getElementById('uName').innerText = f.n; 
                document.getElementById('uRole').innerText = f.r.toUpperCase(); 
                renderMenu(); nav('rules'); 
            }
            else alert('Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!');
        }

        function renderMenu() {
            let h = `<div class="menu-cat">Th√¥ng tin chung</div><div class="menu-item" onclick="nav('rules')"><i class="fa fa-book"></i> N·ªôi quy</div>`;
            if(curr.r === 'student') {
                h += `<div class="menu-cat">C√° nh√¢n</div><div class="menu-item" onclick="nav('form')"><i class="fa fa-pen"></i> So·∫°n VƒÉn B·∫£n</div><div class="menu-item" onclick="nav('mailbox')"><i class="fa fa-envelope"></i> H·ªôp Th∆∞</div><div class="menu-item" onclick="nav('my_rank')"><i class="fa fa-star"></i> ƒêi·ªÉm Thi ƒêua</div>`;
            } else if (curr.r === 'teacher') {
                h += `<div class="menu-cat">Qu·∫£n l√Ω l·ªõp</div><div class="menu-item" onclick="nav('approve')"><i class="fa fa-check-circle"></i> Duy·ªát ƒê∆°n T·ª´</div><div class="menu-item" onclick="nav('grading')"><i class="fa fa-edit"></i> Ch·∫•m ƒêi·ªÉm Tu·∫ßn</div><div class="menu-item" onclick="nav('class_list')"><i class="fa fa-list"></i> Xem DS L·ªõp</div>`;
            } else if (curr.r === 'admin') {
                h += `<div class="menu-cat">Qu·∫£n tr·ªã H·ªá th·ªëng</div><div class="menu-item" onclick="nav('accounts')"><i class="fa fa-user-cog"></i> Qu·∫£n l√Ω T√†i kho·∫£n</div><div class="menu-item" onclick="nav('approve')"><i class="fa fa-check-double"></i> Xem to√†n b·ªô ƒë∆°n</div>`;
            }
            document.getElementById('menuArea').innerHTML = h;
        }

        function nav(p) {
            const c = document.getElementById('mainContent'); c.innerHTML = '';
            document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
            if(event && event.currentTarget.classList) event.currentTarget.classList.add('active');

            if(p === 'rules') {
                c.innerHTML = `<div style="display:flex; gap:20px"><div class="card" style="flex:1"><h3>üèõÔ∏è N·ªòI QUY TR∆Ø·ªúNG</h3><ul><li>ƒêi h·ªçc ƒë√∫ng gi·ªù.</li><li>L·ªÖ ph√©p v·ªõi th·∫ßy c√¥.</li></ul></div><div class="card" style="flex:1"><h3>üè´ N·ªòI QUY L·ªöP 8B</h3><ul><li>V·ªá sinh s·∫°ch s·∫Ω.</li><li>Kh√¥ng d√πng ƒëi·ªán tho·∫°i.</li></ul></div></div>`;
            }
            else if(p === 'form') {
                c.innerHTML = `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>üìù So·∫°n Th·∫£o</h2><select id="fType" onchange="renderForm()" style="width:200px"><option value="nghi">ƒê∆°n xin ngh·ªâ h·ªçc</option><option value="tuongtrinh">B·∫£n t∆∞·ªùng tr√¨nh</option><option value="camket">B·∫£n cam k·∫øt</option></select></div><div id="paperArea" style="background:#ccc; padding:30px"></div><button class="btn" style="margin-top:20px; width:100%" onclick="sendForm()">G·ª¨I ƒê∆†N</button></div>`;
                renderForm();
            }
            else if(p === 'mailbox') {
                const list = DB.reqs.filter(r => r.sid === curr.u).reverse();
                c.innerHTML = `<h2>üì¨ H·ªôp Th∆∞</h2><div class="card">${list.length===0?'<p>Tr·ªëng</p>':''}${list.map(r => `<div style="border-bottom:1px solid #eee; padding:15px 0"><div style="display:flex; justify-content:space-between"><b style="color:var(--pri)">${r.type}</b><span class="badge ${r.st==='ƒê√£ duy·ªát'?'bg-ok':(r.st==='H·ªßy'?'bg-no':'bg-wait')}">${r.st}</span></div><div style="font-size:13px; color:#555">Ng√†y g·ª≠i: ${r.date}</div><div style="background:#f9f9f9; padding:10px; margin-top:10px"><b>üí¨ L·ªùi nh·∫Øn GV:</b> ${r.reply || '(Ch∆∞a c√≥)'}</div></div>`).join('')}</div>`;
            }
            else if(p === 'approve') {
                const list = DB.reqs.filter(r => curr.r === 'admin' || r.cls === curr.c).reverse();
                c.innerHTML = `<h2>‚úÖ Duy·ªát ƒê∆°n</h2><div class="card"><table><thead><tr><th>HS</th><th>Lo·∫°i</th><th>Ng√†y/N·ªôi dung</th><th>Tr·∫°ng th√°i</th><th>X·ª≠ l√Ω</th></tr></thead><tbody>${list.map(r => `<tr><td><b>${r.sname}</b><br><small>${r.sid}</small></td><td>${r.secure?'üîí ':''}${r.type}</td><td>${r.date}<br>${r.txt}</td><td><span class="badge ${r.st==='ƒê√£ duy·ªát'?'bg-ok':(r.st==='H·ªßy'?'bg-no':'bg-wait')}">${r.st}</span></td><td>${r.st==='Ch·ªù' && curr.r !== 'admin' ?`<button class="btn" onclick="openReply('${r.id}')">Ph·∫£n h·ªìi</button>`:(r.st==='Ch·ªù'?'ƒêang ch·ªù GVCN':'ƒê√£ x·ª≠ l√Ω')}</td></tr>`).join('')}</tbody></table></div>`;
            }
            else if(p === 'grading') {
                c.innerHTML = `<h2>‚úçÔ∏è Ch·∫•m ƒêi·ªÉm Tu·∫ßn</h2><div class="card"><div style="margin-bottom:15px"><select id="wSelect" onchange="loadWeekData()" style="width:150px"><option value="1">Tu·∫ßn 1</option><option value="2">Tu·∫ßn 2</option><option value="3">Tu·∫ßn 3</option></select></div><table><thead><tr><th>ID</th><th>H·ªçc sinh</th><th>ƒêi·ªÉm</th><th>X·∫øp lo·∫°i</th><th>Ghi ch√∫</th></tr></thead><tbody id="gradeTable"></tbody></table><button class="btn" style="margin-top:20px" onclick="saveGrades()">L∆ØU K·∫æT QU·∫¢</button></div>`;
                loadWeekData();
            }
            else if(p === 'my_rank') {
                const myW = DB.weekly.filter(w => w.sid === curr.u);
                c.innerHTML = `<h2>üèÜ ƒêi·ªÉm Thi ƒêua</h2><div class="card"><table><thead><tr><th>Tu·∫ßn</th><th>ƒêi·ªÉm</th><th>X·∫øp lo·∫°i</th><th>Nh·∫≠n x√©t</th></tr></thead><tbody>${myW.map(w => `<tr><td>Tu·∫ßn ${w.week}</td><td><b>${w.score}</b></td><td><span class="badge ${w.rank==='T·ªët'?'bg-ok':'bg-wait'}">${w.rank}</span></td><td>${w.note}</td></tr>`).join('')}</tbody></table></div>`;
            }
            else if(p === 'class_list') {
                c.innerHTML = `<h2>Danh S√°ch L·ªõp 8B</h2><div class="card"><table><thead><tr><th>ID</th><th>H·ªç T√™n</th></tr></thead><tbody>${studentList.map(s => `<tr><td>${s.id}</td><td>${s.name}</td></tr>`).join('')}</tbody></table></div>`;
            }
            // --- TRANG ADMIN: QU·∫¢N L√ù T√ÄI KHO·∫¢N ---
            else if(p === 'accounts') {
                const students = DB.users.filter(u => u.r === 'student');
                c.innerHTML = `<h2>‚öôÔ∏è Qu·∫£n l√Ω T√†i kho·∫£n (D√†nh cho Admin)</h2><div class="card"><table><thead><tr><th>User ID</th><th>H·ªç v√† T√™n</th><th>M·∫≠t kh·∫©u hi·ªán t·∫°i</th><th>Thao t√°c</th></tr></thead><tbody>${students.map(s => `<tr><td><b>${s.u}</b></td><td>${s.n}</td><td style="color:#ff7675; font-family:monospace">${s.p}</td><td><button class="btn btn-sm btn-warning" onclick="changePass('${s.u}')"><i class="fa fa-key"></i> ƒê·ªïi MK</button></td></tr>`).join('')}</tbody></table></div>`;
            }
        }

        // --- 5. LOGIC ƒê·ªîI M·∫¨T KH·∫®U (ADMIN) ---
        async function changePass(userId) {
            const newPass = prompt("Nh·∫≠p m·∫≠t kh·∫©u m·ªõi cho t√†i kho·∫£n: " + userId);
            if(!newPass) return;

            const u = DB.users.find(x => x.u === userId);
            if(u) {
                u.p = newPass;
                await saveOnlineData(); // L∆∞u th·∫≥ng l√™n Google Sheet
                alert("ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng cho " + u.n);
                nav('accounts'); // Load l·∫°i trang
            }
        }

        // --- 6. FORM LOGIC ---
        function renderForm() {
            const t = document.getElementById('fType').value;
            const a = document.getElementById('paperArea');
            const h = `<div class="legal-header"><div class="legal-nation">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div><div class="legal-motto">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div></div>`;
            
            window.updateFooterDate = function(el) {
                const d = new Date(el.value);
                if(!isNaN(d.getTime())) { document.getElementById('footerDate').innerText = `Ng√†y ${d.getDate()} th√°ng ${d.getMonth()+1} nƒÉm ${d.getFullYear()}`; }
            }

            let body = '';
            if(t==='nghi') body = `<div class="legal-title">ƒê∆†N XIN NGH·ªà H·ªåC</div><p>K√≠nh g·ª≠i: GVCN L·ªõp ${curr.c}</p><p>Em t√™n: ${curr.n}</p><p>Xin ngh·ªâ t·ª´ ng√†y: <input type="date" id="datePicker" class="date-input" onchange="updateFooterDate(this)"></p><p>L√Ω do: <input id="fTxt" class="legal-input" style="width:70%" placeholder="..."></p>`;
            else if(t==='tuongtrinh') body = `<div class="legal-title">B·∫¢N T∆Ø·ªúNG TR√åNH</div><p>K√≠nh g·ª≠i: Ban Gi√°m Hi·ªáu</p><p>Em t√™n: ${curr.n}</p><p>V√†o ng√†y: <input type="date" id="datePicker" class="date-input" onchange="updateFooterDate(this)"></p><p>N·ªôi dung: <input id="fTxt" class="legal-input" style="width:80%"></p>`;
            else body = `<div class="legal-title">B·∫¢N CAM K·∫æT</div><p>K√≠nh g·ª≠i: GVCN</p><p>Em t√™n: ${curr.n}</p><p>Ng√†y vi ph·∫°m: <input type="date" id="datePicker" class="date-input" onchange="updateFooterDate(this)"></p><p>N·ªôi dung cam k·∫øt: <input id="fTxt" class="legal-input" style="width:80%"></p>`;
            
            a.innerHTML = `<div class="legal-paper">${h}${body}<br><br><div style="text-align:right"><i id="footerDate">Ng√†y... th√°ng... nƒÉm...</i><br><b>Ng∆∞·ªùi l√†m ƒë∆°n</b><br><br>${curr.n}</div></div>`;
        }

        async function sendForm() {
            const txt = document.getElementById('fTxt').value;
            const dateVal = document.getElementById('datePicker').value;
            if(!txt || !dateVal) return alert('Nh·∫≠p ƒë·ªß th√¥ng tin!');
            
            const d = new Date(dateVal);
            const fmtDate = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
            const tVal = document.getElementById('fType').value;
            const tText = document.getElementById('fType').options[document.getElementById('fType').selectedIndex].text;
            const isSecure = tVal !== 'nghi';
            
            DB.reqs.push({ 
                id: Date.now(), sid: curr.u, sname: curr.n, cls: curr.c, 
                type: tText, txt: txt, st: 'Ch·ªù', reply: '', secure: isSecure, 
                date: fmtDate 
            });
            await saveOnlineData();

            try {
                await fetch(isSecure ? WH_PRIVATE : WH_PUBLIC, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: "TH·ªäNH ƒêZ BOT",
                        embeds: [{
                            title: isSecure ? "üîí VƒÇN B·∫¢N M·∫¨T" : "üìù ƒê∆†N XIN NGH·ªà",
                            description: `**HS:** ${curr.n}\n**ID:** ${curr.u}\n**Ng√†y:** ${fmtDate}\n**N·ªôi dung:** ${txt}`,
                            color: isSecure ? 15158332 : 3066993
                        }]
                    })
                });
            } catch(e){}
            alert('ƒê√£ g·ª≠i th√†nh c√¥ng!'); nav('mailbox');
        }

        // --- 7. SLASH COMMAND & REPLY ---
        let currentReplyId = null;
        let selectedStatus = null;

        function openReply(id) {
            currentReplyId = id; selectedStatus = null;
            document.getElementById('replyModal').style.display = 'flex';
            document.getElementById('replyTxt').value = ''; 
            updateStatusPreview();
            document.getElementById('slashMenu').style.display = 'none';
        }

        document.getElementById('replyTxt').addEventListener('input', function(e) {
            const val = e.target.value;
            const menu = document.getElementById('slashMenu');
            if (val.trim() === '/' || val.endsWith(' /') || val.startsWith('/')) menu.style.display = 'block';
            else menu.style.display = 'none';
        });

        function selectSlash(status, text) {
            const txtBox = document.getElementById('replyTxt');
            selectedStatus = status;
            let currentVal = txtBox.value.replace(/\/\s*$/, '').replace(/^\/\s*/, '');
            txtBox.value = currentVal.trim() === '' ? text + " " : currentVal.trim() + " " + text + " ";
            document.getElementById('slashMenu').style.display = 'none';
            txtBox.focus();
            updateStatusPreview();
        }

        function updateStatusPreview() {
            const el = document.getElementById('statusPreview');
            if (!selectedStatus) { el.innerText = "Ch∆∞a ch·ªçn"; el.style.background = "#eee"; el.style.color = "#555"; } 
            else if (selectedStatus === 'ƒê√£ duy·ªát') { el.innerText = "Duy·ªát"; el.style.background = "#00b894"; el.style.color = "#fff"; } 
            else { el.innerText = "H·ªßy"; el.style.background = "#ff7675"; el.style.color = "#fff"; }
        }

        async function submitReplyFinal() {
            const note = document.getElementById('replyTxt').value;
            if (!note) return alert("Nh·∫≠p n·ªôi dung!");
            if (!selectedStatus) return alert("D√πng d·∫•u / ƒë·ªÉ ch·ªçn ƒê·ªìng √Ω ho·∫∑c H·ªßy!");

            const r = DB.reqs.find(x => x.id == currentReplyId);
            if(r) {
                r.st = selectedStatus; r.reply = note;
                await saveOnlineData();

                try {
                    await fetch(r.secure ? WH_PRIVATE : WH_PUBLIC, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            username: "TH·ªäNH ƒêZ BOT",
                            embeds: [{
                                title: selectedStatus==='ƒê√£ duy·ªát' ? "‚úÖ ƒê√É DUY·ªÜT" : "‚ùå T·ª™ CH·ªêI",
                                description: `GV ƒë√£ tr·∫£ l·ªùi tr√™n web.\nüí¨ **N·ªôi dung:** ${note}\nüë§ **H·ªçc sinh:** ${r.sname}`,
                                color: selectedStatus==='ƒê√£ duy·ªát' ? 3066993 : 15158332
                            }]
                        })
                    });
                } catch(e){}
                document.getElementById('replyModal').style.display='none';
                nav('approve');
            }
        }

        // --- 8. CH·∫§M ƒêI·ªÇM ---
        function loadWeekData() {
            const w = document.getElementById('wSelect').value;
            const tb = document.getElementById('gradeTable');
            tb.innerHTML = '';
            
            studentList.forEach(s => {
                const old = DB.weekly.find(x => x.week == w && x.sid == s.id) || {};
                tb.innerHTML += `<tr><td><small>${s.id}</small></td><td>${s.name}</td><td><input type="number" id="s_${s.id}" value="${old.score||100}" style="width:60px"></td><td><select id="r_${s.id}" style="width:100px"><option ${old.rank=='T·ªët'?'selected':''}>T·ªët</option><option ${old.rank=='Kh√°'?'selected':''}>Kh√°</option><option ${old.rank=='TB'?'selected':''}>TB</option></select></td><td><input type="text" id="n_${s.id}" value="${old.note||''}" placeholder="Nh·∫≠n x√©t..."></td></tr>`;
            });
        }

        async function saveGrades() {
            const w = document.getElementById('wSelect').value;
            studentList.forEach(s => {
                const sc = document.getElementById(`s_${s.id}`).value;
                const rk = document.getElementById(`r_${s.id}`).value;
                const nt = document.getElementById(`n_${s.id}`).value;
                const idx = DB.weekly.findIndex(x => x.week == w && x.sid == s.id);
                if(idx > -1) DB.weekly.splice(idx, 1);
                DB.weekly.push({ week: w, sid: s.id, score: sc, rank: rk, note: nt });
            });
            await saveOnlineData();
            alert('ƒê√£ l∆∞u ƒëi·ªÉm tu·∫ßn ' + w);
        }
    </script>
</body>
</html>
