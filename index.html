<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH·ªäNH ƒêZ EDU - L·ªõp 8B</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GI·ªÆ NGUY√äN GIAO DI·ªÜN C≈® --- */
        :root { --pri: #4e54c8; --sec: #8f94fb; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #loginWrap { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); display:flex; justify-content:center; align-items:center; z-index:999; }
        .login-box { background:white; padding:40px; border-radius:15px; width:380px; text-align:center; box-shadow:0 15px 40px rgba(0,0,0,0.2); }
        
        #appWrap { display:none; height:100%; }
        .sidebar { width:260px; background:#fff; display:flex; flex-direction:column; border-right:1px solid #ddd; }
        .content { flex:1; padding:30px; overflow-y:auto; background: var(--bg); }
        
        .user-panel { padding:20px; background:linear-gradient(135deg, var(--pri), var(--sec)); color:white; display:flex; align-items:center; gap:15px; }
        .menu-scroll { flex:1; overflow-y:auto; padding:10px; }
        .menu-cat { font-size:11px; font-weight:bold; color:#888; text-transform:uppercase; margin:15px 0 5px 10px; }
        .menu-item { padding:12px 15px; border-radius:8px; cursor:pointer; display:flex; gap:12px; align-items:center; color:#555; font-weight:600; transition:0.2s; }
        .menu-item:hover, .menu-item.active { background:#eef2ff; color:var(--pri); }
        
        .card { background:white; border-radius:12px; padding:25px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.03); animation: slideIn 0.4s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        
        input, select, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; outline:none; box-sizing:border-box; }
        .btn { background:var(--pri); color:white; padding:10px 20px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.2s; }
        
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th { text-align:left; color:#777; font-size:12px; text-transform:uppercase; padding:10px; border-bottom:2px solid #eee; }
        td { padding:12px 10px; border-bottom:1px solid #eee; vertical-align:middle; }
        
        /* LEGAL PAPER */
        .legal-paper { background: #fff; padding: 40px 50px; border: 1px solid #ccc; font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 0 auto; max-width: 800px; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); }
        .legal-header { text-align: center; margin-bottom: 20px; }
        .legal-nation { font-weight: bold; text-transform: uppercase; }
        .legal-motto { font-weight: bold; border-bottom: 1px solid #000; display: inline-block; padding-bottom: 5px; }
        .legal-title { text-align: center; font-weight: bold; text-transform: uppercase; font-size: 16pt; margin: 30px 0; }
        .legal-input { border: none; border-bottom: 1px dotted #000; outline: none; width: auto; background: transparent; font-family: inherit; font-size: inherit; }
        .date-input { font-family: inherit; font-size: inherit; border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; background: #fffbe6; cursor: pointer; }

        .badge { padding:4px 10px; border-radius:20px; font-size:11px; font-weight:bold; color:white; }
        .bg-ok { background:#00b894; } .bg-wait { background:#fdcb6e; color:#333; } .bg-no { background:#ff7675; }
    </style>
</head>
<body>

    <div id="loginWrap">
        <div class="login-box">
            <h2 style="color:var(--pri); margin-bottom:5px">TH·ªäNH ƒêZ EDU</h2>
            <p style="color:#888; font-size:13px; margin-bottom:25px">Qu·∫£n l√Ω L·ªõp 8B - NƒÉm h·ªçc 2025-2026</p>
            <input id="user" placeholder="T√™n ƒëƒÉng nh·∫≠p (gv / m.an, d.anh...)">
            <input id="pass" type="password" placeholder="M·∫≠t kh·∫©u (123)">
            <button class="btn" style="width:100%" onclick="login()">ƒêƒÉng Nh·∫≠p</button>
            <div style="margin-top:15px; font-size:12px; color:#666">
                <i>T√†i kho·∫£n m·∫´u: <b>m.an</b> (Minh An), <b>d.anh</b> (Di·ªáu Anh)...</i>
            </div>
        </div>
    </div>

    <div id="appWrap">
        <div class="sidebar">
            <div class="user-panel">
                <div style="width:45px; height:45px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center"><i class="fa fa-user"></i></div>
                <div><div style="font-weight:bold" id="uName">User</div><small id="uRole">Role</small></div>
            </div>
            <div class="menu-scroll" id="menuArea"></div>
            <div style="padding:15px; border-top:1px solid #eee">
                <button onclick="location.reload()" class="btn" style="width:100%; background:#fff; color:#ff7675; border:1px solid #ff7675"><i class="fa fa-power-off"></i> ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        <div class="content" id="mainContent"></div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH WEBHOOK (Thay link c·ªßa b·∫°n) ---
        const WH_PUBLIC = "https://discord.com/api/webhooks/1462374350341669191/PS9ts11QNh7Fe_Bm1rhuu0vfNE1aw1nHEMhSjTaFgmrOcDrS2Yj9e9yoiT2cmWTtFcc-";
        const WH_PRIVATE = "https://discord.com/api/webhooks/1462374646837022806/UkCViqUB5WHvST6mv2xNDpZSVocrCuvmo6iQh0CNR4vfO2lt8F_pdo5s7Ee1I5Rn1Hjz";

        // --- 2. H√ÄM T·∫†O USERNAME T·ª™ T√äN ---
        function removeVietnameseTones(str) {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
            str = str.replace(/ƒë/g,"d");
            str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, "A");
            str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, "E");
            str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, "I");
            str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, "O");
            str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, "U");
            str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, "Y");
            str = str.replace(/ƒê/g, "D");
            return str;
        }

        function createUsername(fullName) {
            let cleanName = removeVietnameseTones(fullName).toLowerCase().trim();
            let parts = cleanName.split(/\s+/); // T√°ch c√°c t·ª´
            if (parts.length < 2) return cleanName; // T√™n ng·∫Øn qu√° gi·ªØ nguy√™n
            
            let firstName = parts[parts.length - 1]; // T√™n (An)
            let middleName = parts[parts.length - 2]; // T√™n ƒë·ªám (Minh)
            let initial = middleName.charAt(0); // Ch·ªØ c√°i ƒë·∫ßu t√™n ƒë·ªám (m)
            
            return `${initial}.${firstName}`; // m.an
        }

        // --- 3. DATA H·ªåC SINH (42 EM) ---
        const rawStudents = [
            'B√πi V≈© Minh An', 'Tr∆∞∆°ng Th·ªã Di·ªáu Anh', 'L∆∞∆°ng Gia B·∫£o', '√ä Ban Any T√πng', 'Nguy·ªÖn Cao Tr∆∞·ªùng H·∫£i', 
            'ƒê·ªó Ng·ªçc H√¢n', 'ƒêinh Th·ªã B√≠ch Hi·ªÅn', 'L√™ VƒÉn Hi·∫øu', 'Hu·ª≥nh Nguy·ªÖn Minh Ho√†ng', 'L√™ Ng·ªçc Ho√†ng', 
            'D∆∞∆°ng Qu·ªëc Kh·∫£i', 'Nguy·ªÖn Ng·ªçc Thi√™n Kim', 'Hu·ª≥nh Cao Nh·∫≠t L√¢m', 'Nguy·ªÖn Quang Long', 'TRI·ªÜU M·∫™N', 
            'TƒÉng H·ªØu Nam', 'Nguy·ªÖn Th√πy B·∫£o Ng√¢n', 'Nguy·ªÖn Tr·∫ßn Ng·ªçc Ng√¢n', 'Nguy·ªÖn Ho√†ng B·∫£o Ng·ªçc', 'Ph·∫°m Minh Ph∆∞·ªõc', 
            'L√™ Ho√†ng Qu√¢n', 'Nguy·ªÖn ƒêƒÉng Qu√¢n', 'Tr·∫ßn Qu·ªëc Qu√¢n', 'Nguy·ªÖn Th·ª•c Quy√™n', 'T·ªëng Thanh Thanh', 
            'L√™ VƒÉn Th·∫£o', 'Tr·∫ßn B·∫£o Th·∫Øng', 'Tr·∫ßn Th·∫Øng', 'L√™ Tr·∫ßn Ph√∫c Thi√™n', 'L√™ Th·∫ø Th·ªãnh', 
            'Ng√¥ Nguy·ªÖn B·∫£o Th·ªãnh', 'L∆∞∆°ng Nguy·ªÖn Anh Th∆∞', 'Nguy·ªÖn Anh Th∆∞', 'Tr·ªãnh Nguy·ªÖn Minh Th∆∞', 'Tr·∫ßn Ho√†i Th∆∞∆°ng', 
            'Nguy·ªÖn Ng·ªçc Kh√°nh Thy', 'ƒê·ªó Ph·∫°m Huy·ªÅn Tr√¢n', 'Tr·∫ßn Th·ªã B·∫£o Tr√¢n', 'Ho√†ng Th·ªßy Tr√∫c', 'Nguy·ªÖn Hu·ª≥nh Nh∆∞ Tr√∫c', 
            'Ph·∫°m Thanh Trung', 'V√µ Ho√†ng Th·ª•y V√¢n'
        ];

        // T·ª± ƒë·ªông t·∫°o usersDB v·ªõi ID ƒë·∫πp v√† x·ª≠ l√Ω tr√πng
        const usersDB = [
            { u: 'admin', p: '123', n: 'Admin H·ªá Th·ªëng', r: 'admin', c: 'ALL' },
            { u: 'gv', p: '123', n: 'GVCN L·ªõp 8B', r: 'teacher', c: '8B' }
        ];
        
        const studentList = [];
        const usedIds = {}; // ƒê·ªÉ check tr√πng

        rawStudents.forEach((name, index) => {
            let baseId = createUsername(name);
            let finalId = baseId;
            
            // X·ª≠ l√Ω n·∫øu tr√πng ID (v√≠ d·ª• 2 b·∫°n t√™n Th∆∞ -> a.thu v√† a.thu1)
            if (usedIds[baseId]) {
                finalId = baseId + usedIds[baseId];
                usedIds[baseId]++;
            } else {
                usedIds[baseId] = 1;
            }

            // Th√™m v√†o DB user ƒë·ªÉ ƒëƒÉng nh·∫≠p
            usersDB.push({ u: finalId, p: '123', n: name, r: 'student', c: '8B' });
            
            // Th√™m v√†o danh s√°ch ƒë·ªÉ GV ch·∫•m ƒëi·ªÉm (c√≥ l∆∞u ID ƒë·ªÉ kh·ªõp)
            studentList.push({ id: finalId, name: name });
        });

        // console.log(usersDB); // B·∫≠t c√°i n√†y l√™n F12 ƒë·ªÉ xem danh s√°ch t√†i kho·∫£n n·∫øu c·∫ßn

        const DB = {
            users: usersDB,
            students: studentList, 
            reqs: JSON.parse(localStorage.getItem('tdz_8b_v2_reqs')) || [],
            weekly: JSON.parse(localStorage.getItem('tdz_8b_v2_week')) || []
        };
        let curr = null;

        function save() {
            localStorage.setItem('tdz_8b_v2_reqs', JSON.stringify(DB.reqs));
            localStorage.setItem('tdz_8b_v2_week', JSON.stringify(DB.weekly));
        }

        // --- 4. CORE ---
        function login() {
            const u = document.getElementById('user').value.toLowerCase().trim(); // Cho ph√©p nh·∫≠p ch·ªØ hoa/th∆∞·ªùng
            const p = document.getElementById('pass').value;
            const f = DB.users.find(x => x.u == u && x.p == p);
            if(f) { curr=f; document.getElementById('loginWrap').style.display='none'; document.getElementById('appWrap').style.display='flex'; document.getElementById('uName').innerText=f.n; document.getElementById('uRole').innerText=f.r.toUpperCase(); renderMenu(); nav('rules'); }
            else alert('Sai th√¥ng tin! H√£y th·ª≠: m.an / 123');
        }

        function renderMenu() {
            let h = `<div class="menu-cat">Th√¥ng tin chung</div><div class="menu-item" onclick="nav('rules')"><i class="fa fa-book"></i> N·ªôi quy</div>`;
            if(curr.r === 'student') h += `<div class="menu-cat">C√° nh√¢n</div><div class="menu-item" onclick="nav('form')"><i class="fa fa-pen"></i> So·∫°n VƒÉn B·∫£n</div><div class="menu-item" onclick="nav('mailbox')"><i class="fa fa-envelope"></i> H·ªôp Th∆∞</div><div class="menu-item" onclick="nav('my_rank')"><i class="fa fa-star"></i> ƒêi·ªÉm Thi ƒêua</div>`;
            else h += `<div class="menu-cat">Qu·∫£n l√Ω</div><div class="menu-item" onclick="nav('approve')"><i class="fa fa-check-circle"></i> Duy·ªát ƒê∆°n T·ª´</div><div class="menu-item" onclick="nav('grading')"><i class="fa fa-edit"></i> Ch·∫•m ƒêi·ªÉm Tu·∫ßn</div><div class="menu-item" onclick="nav('class_list')"><i class="fa fa-list"></i> Xem DS L·ªõp</div>`;
            document.getElementById('menuArea').innerHTML = h;
        }

        function nav(p) {
            const c = document.getElementById('mainContent'); c.innerHTML = '';

            if(p === 'rules') {
                c.innerHTML = `<div style="display:flex; gap:20px"><div class="card" style="flex:1"><h3>üèõÔ∏è N·ªòI QUY TR∆Ø·ªúNG</h3><ul><li>ƒêi h·ªçc ƒë√∫ng gi·ªù.</li><li>L·ªÖ ph√©p v·ªõi th·∫ßy c√¥.</li></ul></div><div class="card" style="flex:1"><h3>üè´ N·ªòI QUY L·ªöP 8B</h3><ul><li>V·ªá sinh s·∫°ch s·∫Ω.</li><li>Kh√¥ng d√πng ƒëi·ªán tho·∫°i.</li></ul></div></div>`;
            }
            else if(p === 'form') {
                c.innerHTML = `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>üìù So·∫°n Th·∫£o</h2><select id="fType" onchange="renderForm()" style="width:200px"><option value="nghi">ƒê∆°n xin ngh·ªâ h·ªçc</option><option value="tuongtrinh">B·∫£n t∆∞·ªùng tr√¨nh</option><option value="camket">B·∫£n cam k·∫øt</option></select></div><div id="paperArea" style="background:#ccc; padding:30px"></div><button class="btn" style="margin-top:20px; width:100%" onclick="sendForm()">G·ª¨I ƒê∆†N</button></div>`;
                renderForm();
            }
            else if(p === 'mailbox') {
                const list = DB.reqs.filter(r => r.sid === curr.u).reverse();
                c.innerHTML = `<h2>üì¨ H·ªôp Th∆∞</h2><div class="card">${list.length===0?'<p>Tr·ªëng</p>':''}${list.map(r => `<div style="border-bottom:1px solid #eee; padding:15px 0"><div style="display:flex; justify-content:space-between"><b style="color:var(--pri)">${r.type}</b><span class="badge ${r.st==='ƒê√£ duy·ªát'?'bg-ok':(r.st==='H·ªßy'?'bg-no':'bg-wait')}">${r.st}</span></div><div style="font-size:13px; color:#555">Ng√†y g·ª≠i: ${r.date}</div><div style="background:#f9f9f9; padding:10px; margin-top:10px"><b>üí¨ L·ªùi nh·∫Øn GV:</b> ${r.reply || '(Ch∆∞a c√≥)'}</div></div>`).join('')}</div>`;
            }
            else if(p === 'approve') {
                const list = DB.reqs.filter(r => r.cls === curr.c).reverse();
                c.innerHTML = `<h2>‚úÖ Duy·ªát ƒê∆°n (L·ªõp ${curr.c})</h2><div class="card"><table><thead><tr><th>HS</th><th>Lo·∫°i</th><th>Ng√†y/N·ªôi dung</th><th>Tr·∫°ng th√°i</th><th>X·ª≠ l√Ω</th></tr></thead><tbody>${list.map(r => `<tr><td><b>${r.sname}</b><br><small>${r.sid}</small></td><td>${r.secure?'üîí ':''}${r.type}</td><td>${r.date}<br>${r.txt}</td><td><span class="badge ${r.st==='ƒê√£ duy·ªát'?'bg-ok':(r.st==='H·ªßy'?'bg-no':'bg-wait')}">${r.st}</span></td><td>${r.st==='Ch·ªù'?`<button class="btn" style="padding:5px 10px;background:#00b894" onclick="process('${r.id}','ƒê√£ duy·ªát')">‚úî</button> <button class="btn" style="padding:5px 10px;background:#ff7675" onclick="process('${r.id}','H·ªßy')">‚úò</button>`:'OK'}</td></tr>`).join('')}</tbody></table></div>`;
            }
            else if(p === 'grading') {
                c.innerHTML = `<h2>‚úçÔ∏è Ch·∫•m ƒêi·ªÉm Tu·∫ßn</h2><div class="card"><div style="margin-bottom:15px"><select id="wSelect" onchange="loadWeekData()" style="width:150px"><option value="1">Tu·∫ßn 1</option><option value="2">Tu·∫ßn 2</option><option value="3">Tu·∫ßn 3</option></select></div><table><thead><tr><th>User ID</th><th>H·ªçc sinh</th><th>ƒêi·ªÉm</th><th>X·∫øp lo·∫°i</th><th>Ghi ch√∫</th></tr></thead><tbody id="gradeTable"></tbody></table><button class="btn" style="margin-top:20px" onclick="saveGrades()">L∆ØU K·∫æT QU·∫¢</button></div>`;
                loadWeekData();
            }
            else if(p === 'my_rank') {
                const myW = DB.weekly.filter(w => w.sid === curr.u);
                c.innerHTML = `<h2>üèÜ ƒêi·ªÉm Thi ƒêua</h2><div class="card"><table><thead><tr><th>Tu·∫ßn</th><th>ƒêi·ªÉm</th><th>X·∫øp lo·∫°i</th><th>Nh·∫≠n x√©t</th></tr></thead><tbody>${myW.map(w => `<tr><td>Tu·∫ßn ${w.week}</td><td><b>${w.score}</b></td><td><span class="badge ${w.rank==='T·ªët'?'bg-ok':'bg-wait'}">${w.rank}</span></td><td>${w.note}</td></tr>`).join('')}</tbody></table></div>`;
            }
            else if(p === 'class_list') {
                c.innerHTML = `<h2>Danh S√°ch L·ªõp 8B</h2><div class="card"><table><thead><tr><th>ID</th><th>H·ªç T√™n</th><th>M·∫≠t kh·∫©u</th></tr></thead><tbody>${DB.students.map(s => `<tr><td>${s.id}</td><td>${s.name}</td><td>123</td></tr>`).join('')}</tbody></table></div>`;
            }
        }

        // --- 5. FORM LOGIC ---
        function renderForm() {
            const t = document.getElementById('fType').value;
            const a = document.getElementById('paperArea');
            const h = `<div class="legal-header"><div class="legal-nation">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div><div class="legal-motto">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div></div>`;
            
            window.updateFooterDate = function(el) {
                const d = new Date(el.value);
                if(!isNaN(d.getTime())) {
                    document.getElementById('footerDate').innerText = `Ng√†y ${d.getDate()} th√°ng ${d.getMonth()+1} nƒÉm ${d.getFullYear()}`;
                }
            }

            let body = '';
            if(t==='nghi') body = `<div class="legal-title">ƒê∆†N XIN NGH·ªà H·ªåC</div><p>K√≠nh g·ª≠i: GVCN L·ªõp ${curr.c}</p><p>Em t√™n: ${curr.n}</p><p>Xin ngh·ªâ t·ª´ ng√†y: <input type="date" id="datePicker" class="date-input" onchange="updateFooterDate(this)"></p><p>L√Ω do: <input id="fTxt" class="legal-input" style="width:70%" placeholder="..."></p>`;
            else if(t==='tuongtrinh') body = `<div class="legal-title">B·∫¢N T∆Ø·ªúNG TR√åNH</div><p>K√≠nh g·ª≠i: Ban Gi√°m Hi·ªáu</p><p>Em t√™n: ${curr.n}</p><p>V√†o ng√†y: <input type="date" id="datePicker" class="date-input" onchange="updateFooterDate(this)"></p><p>N·ªôi dung: <input id="fTxt" class="legal-input" style="width:80%"></p>`;
            else body = `<div class="legal-title">B·∫¢N CAM K·∫æT</div><p>K√≠nh g·ª≠i: GVCN</p><p>Em t√™n: ${curr.n}</p><p>Ng√†y vi ph·∫°m: <input type="date" id="datePicker" class="date-input" onchange="updateFooterDate(this)"></p><p>N·ªôi dung cam k·∫øt: <input id="fTxt" class="legal-input" style="width:80%"></p>`;
            
            a.innerHTML = `<div class="legal-paper">${h}${body}<br><br><div style="text-align:right"><i id="footerDate">Ng√†y... th√°ng... nƒÉm...</i><br><b>Ng∆∞·ªùi l√†m ƒë∆°n</b><br><br>${curr.n}</div></div>`;
        }

        async function sendForm() {
            const txt = document.getElementById('fTxt').value;
            const dateVal = document.getElementById('datePicker').value;
            if(!txt || !dateVal) return alert('Nh·∫≠p ƒë·ªß th√¥ng tin!');
            
            const d = new Date(dateVal);
            const fmtDate = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
            const tVal = document.getElementById('fType').value;
            const tText = document.getElementById('fType').options[document.getElementById('fType').selectedIndex].text;
            const isSecure = tVal !== 'nghi';
            
            DB.reqs.push({ 
                id: Date.now(), sid: curr.u, sname: curr.n, cls: curr.c, 
                type: tText, txt: txt, st: 'Ch·ªù', reply: '', secure: isSecure, 
                date: fmtDate 
            });
            save();

            try {
                await fetch(isSecure ? WH_PRIVATE : WH_PUBLIC, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: "TH·ªäNH ƒêZ BOT",
                        embeds: [{
                            title: isSecure ? "üîí VƒÇN B·∫¢N M·∫¨T" : "üìù ƒê∆†N XIN NGH·ªà",
                            description: `**HS:** ${curr.n}\n**ID:** ${curr.u}\n**Ng√†y:** ${fmtDate}\n**N·ªôi dung:** ${txt}`,
                            color: isSecure ? 15158332 : 3066993
                        }]
                    })
                });
            } catch(e){}
            alert('ƒê√£ g·ª≠i th√†nh c√¥ng!'); nav('mailbox');
        }

        async function process(id, st) {
            const note = prompt(`Nh·∫≠p l·ªùi nh·∫Øn cho h·ªçc sinh (B·∫Øt bu·ªôc):`, st==='ƒê√£ duy·ªát'?'ƒê·ªìng √Ω':'L√Ω do t·ª´ ch·ªëi...');
            if(!note) return alert('B·∫°n ph·∫£i nh·∫≠p l·ªùi nh·∫Øn!');
            
            const r = DB.reqs.find(x => x.id == id);
            if(r) {
                r.st = st; r.reply = note; save();
                try {
                    await fetch(r.secure ? WH_PRIVATE : WH_PUBLIC, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            username: "TH·ªäNH ƒêZ BOT",
                            embeds: [{ title: st==='ƒê√£ duy·ªát'?"‚úÖ ƒê√É DUY·ªÜT":"‚ùå T·ª™ CH·ªêI", description: `GV ƒë√£ x·ª≠ l√Ω ƒë∆°n c·ªßa **${r.sname}**.\nüí¨ **L·ªùi nh·∫Øn:** ${note}`, color: st==='ƒê√£ duy·ªát'?3066993:15158332 }]
                        })
                    });
                } catch(e){}
                nav('approve');
            }
        }

        // --- 6. LOGIC CH·∫§M ƒêI·ªÇM ---
        function loadWeekData() {
            const w = document.getElementById('wSelect').value;
            const tb = document.getElementById('gradeTable');
            tb.innerHTML = '';
            
            DB.students.forEach(s => {
                const old = DB.weekly.find(x => x.week == w && x.sid == s.id) || {};
                tb.innerHTML += `<tr>
                    <td><small style="color:#888">${s.id}</small></td>
                    <td>${s.name}</td>
                    <td><input type="number" id="s_${s.id}" value="${old.score||100}" style="width:60px"></td>
                    <td><select id="r_${s.id}" style="width:100px"><option ${old.rank=='T·ªët'?'selected':''}>T·ªët</option><option ${old.rank=='Kh√°'?'selected':''}>Kh√°</option><option ${old.rank=='TB'?'selected':''}>TB</option></select></td>
                    <td><input type="text" id="n_${s.id}" value="${old.note||''}" placeholder="Nh·∫≠n x√©t..."></td>
                </tr>`;
            });
        }

        function saveGrades() {
            const w = document.getElementById('wSelect').value;
            DB.students.forEach(s => {
                const sc = document.getElementById(`s_${s.id}`).value;
                const rk = document.getElementById(`r_${s.id}`).value;
                const nt = document.getElementById(`n_${s.id}`).value;
                const idx = DB.weekly.findIndex(x => x.week == w && x.sid == s.id);
                if(idx > -1) DB.weekly.splice(idx, 1);
                DB.weekly.push({ week: w, sid: s.id, score: sc, rank: rk, note: nt });
            });
            save(); alert('ƒê√£ l∆∞u ƒëi·ªÉm tu·∫ßn ' + w);
        }
    </script>
</body>
</html>